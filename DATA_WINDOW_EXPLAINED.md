# 数据窗口和连续预测详解

## 你的问题解答

### 问题：窗口之间有断开吗？

**回答：没有！窗口是滑动的，连续的。**

让我详细解释数据加载器的工作方式：

## 数据加载器的实际工作方式

### 对于单个特征（比如OT）

假设你的测试集有1000个时间点的数据，seq_len=90, pred_len=6：

```
时间轴: 0---90---91---92---93...996---1002
```

数据加载器会创建这样的样本：

```python
样本0:  输入[0:90]     → 预测[90:96]
样本1:  输入[1:91]     → 预测[91:97]
样本2:  输入[2:92]     → 预测[92:98]
样本3:  输入[3:93]     → 预测[93:99]
...
样本N:  输入[N:N+90]   → 预测[N+90:N+96]
```

**关键点**：
- ✅ 每个样本向后**滑动1步**，不是跳跃！
- ✅ 预测目标时间是连续的：90, 91, 92, 93, ...
- ✅ 窗口之间**完全没有断开**

### 对于多变量数据（43个特征）

数据加载器会为**每个特征**创建相同的滑动窗口：

```
特征0 (第一个特征):
  样本0:    输入[0:90]   → 预测[90:96]
  样本1:    输入[1:91]   → 预测[91:97]
  样本2:    输入[2:92]   → 预测[92:98]
  ...

特征1 (第二个特征):
  样本283:  输入[0:90]   → 预测[90:96]
  样本284:  输入[1:91]   → 预测[91:97]
  样本285:  输入[2:92]   → 预测[92:98]
  ...

特征42 (OT):
  样本11886: 输入[0:90]  → 预测[90:96]
  样本11887: 输入[1:91]  → 预测[91:97]
  样本11888: 输入[2:92]  → 预测[92:98]
  ...
```

### 测试脚本如何提取OT

```python
# 1. 收集所有预测
preds_scaled.shape = (12168, 6, 1)  # 所有样本 × 6步 × 1维

# 2. 重塑为 (num_samples, pred_len, num_features)
preds_scaled.shape = (283, 6, 43)   # 283个时间样本 × 6步 × 43特征

# 3. 提取OT（最后一个特征）
preds_scaled_ot = preds_scaled[:, :, -1]
preds_scaled_ot.shape = (283, 6)    # 283个OT预测窗口，每个6步
```

## 新的可视化方案（已实现）

### 图5：连续1步预测线
```python
# 取每个窗口的第1步
continuous_line = [window0[0], window1[0], window2[0], ...]

时间轴:  0   1   2   3   4 ... 200
         |   |   |   |   |     |
窗口0: [90, 91, 92, 93, 94, 95]
         ↑
窗口1:     [91, 92, 93, 94, 95, 96]
            ↑
窗口2:         [92, 93, 94, 95, 96, 97]
                ↑
...

连续线: 90, 91, 92, 93, 94, ... 290
```

**特点**：
- 显示200个连续的1步预测
- 可以看出模型对每个时间点的预测能力
- 适合观察长期趋势

### 图5.5：重叠窗口可视化（新增！）
```python
# 显示30个窗口的全部6步

窗口0:  [0-5]
窗口1:   [1-6]
窗口2:    [2-7]
窗口3:     [3-8]
...

所有窗口叠加在一起显示
```

**特点**：
- 显示30个重叠的6步预测
- 可以看出窗口之间的关系
- 适合理解模型如何处理重叠预测

### 图7：详细窗口对比
显示3个连续窗口的完整6步预测细节

## 实际数据示例

### 你的数据

```
测试集总长度: 假设1000个时间点
seq_len: 90
pred_len: 6

可创建的样本数 = 1000 - 90 - 6 + 1 = 905个
对于43个特征 = 905 × 43 = 38915个样本

经过重塑后:
  OT特征的样本 = 905个滑动窗口
  每个窗口预测6步
```

### 滑动窗口详解

```
窗口0:  时刻0-89   → 预测时刻90-95
窗口1:  时刻1-90   → 预测时刻91-96
窗口2:  时刻2-91   → 预测时刻92-97
窗口3:  时刻3-92   → 预测时刻93-98
...
```

**预测目标的时间点**：
- 窗口0预测: [90, 91, 92, 93, 94, 95]
- 窗口1预测: [91, 92, 93, 94, 95, 96]
- 窗口2预测: [92, 93, 94, 95, 96, 97]
- ...

**注意**：
- 时刻91会被预测2次（窗口0和窗口1）
- 时刻92会被预测3次（窗口0、1、2）
- ...
- 时刻95会被预测6次（窗口0-5）

这就是为什么叫"重叠预测"！

## 现在的7张图表

### 1. 多个预测窗口（归一化）
显示10个独立窗口，每个6步

### 2. 多个预测窗口（原始）
同上，原始尺度

### 3. 并排对比
归一化 vs 原始尺度

### 4. 误差分布
直方图

### 5. 连续1步预测（新！）
200个连续时间点的1步预测

### 5.5 重叠窗口可视化（新！）
30个重叠的6步预测窗口

### 7. 详细窗口
3个窗口的完整6步细节

## 运行效果

```bash
bash ./scripts/GPT2_PPData_test_OT.sh
```

会生成：

```
[5/7] Plotting continuous time series (200 steps)...
  Using 200 consecutive prediction windows
  ✓ Saved: *_OT_continuous.png          # 连续200步的1步预测
  Creating overlapping multi-step view...
  ✓ Saved: *_OT_overlapping.png         # 30个重叠窗口

[6/7] Plotting overlapping prediction windows...
[7/7] Plotting detailed multi-step predictions...
  ✓ Saved: *_OT_detailed.png            # 3个详细窗口
```

## 总结

### 数据特点
- ✅ 窗口是**滑动的**，每次移动1步
- ✅ 预测目标时间是**连续的**
- ✅ **没有断开**，完全连续
- ✅ 有重叠（同一时刻被多个窗口预测）

### 可视化特点
- **图5**：显示连续的1步预测趋势
- **图5.5**：显示重叠窗口，理解预测机制
- **图7**：显示详细的多步预测

### 为什么看起来只有几个点？

**之前的问题**：每张图只显示1个窗口的6个点
**现在的解决**：
- 图5显示200个连续点
- 图5.5显示30个窗口×6步的重叠
- 可以看到长期连续趋势了！
